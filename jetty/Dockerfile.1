FROM openjdk:8

RUN groupadd -r amelco && useradd -r -g amelco ameclo

ENV JETTY_HOME /opt/jetty
ENV ATS_INSTANCE ats

ENV ATS_INSTANCE_LOCATION /app/$ATS_INSTANCE
ENV ATS_LIB_LOCATION      $ATS_INSTANCE_LOCATION/lib
ENV ATS_LOG_LOCATION      $ATS_INSTANCE_LOCATION/ats_logs
ENV ATS_CONFIG_LOCATION   $ATS_INSTANCE_LOCATION/conf
ENV ATS_PATCHES_LOCATION  $ATS_INSTANCE_LOCATION/patches

ENV JETTY_DEPLOYMENT true
ENV RIG srv1

ENV JAVA_OPTS "$JAVA_OPTS -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+UseConcMarkSweepGC -XX:MaxPermSize=128M -Xms256m -Xmx2048m -server -verbose:gc -XX:-OmitStackTraceInFastThrow"
ENV JETTY_OPTS "-Djetty.home=$JETTY_HOME -Dcom.sun.management.jmxremote"
ENV JETTY_PORT 8010
ENV ATS_OPTS "-Dats.env=nonJndi -Dlog4j.configurationFile=file:$ATS_CONFIG_LOCATION/log4j2.xml"

ENV CLASSPATH "$JETTY_HOME/lib/*:$JETTY_HOME/lib/jsp/*"
ENV CLASSPATH "$ATS_PATCHES_LOCATION:$ATS_LIB_LOCATION:$CLASSPATH"
ENV JAVA_AGENT "-javaagent:$ATS_LIB_LOCATION/ats-properties-1.3.0.jar=$ATS_CONFIG_LOCATION/ats.properties"

RUN mkdir -p $ATS_INSTANCE_LOCATION $ATS_LOG_LOCATION && \
mkdir -p $ATS_CONFIG_LOCATION $ATS_LIB_LOCATION

ADD files/jetty $JETTY_HOME
ADD files/config $ATS_CONFIG_LOCATION
ADD files/jetty-template $ATS_INSTANCE_LOCATION/server

ADD entrypoint.sh $ATS_INSTANCE_LOCATION
RUN chmod +x $ATS_INSTANCE_LOCATION/entrypoint.sh

WORKDIR $ATS_INSTANCE_LOCATION
EXPOSE $JETTY_PORT

ENTRYPOINT $ATS_INSTANCE_LOCATION/entrypoint.sh